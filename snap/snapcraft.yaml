name: vlc
adopt-info: vlc
grade: stable
base: core24
summary: Read, capture, broadcast your multimedia streams
description: |
  VLC is a free and open source cross-platform multimedia player and
  framework that plays most multimedia files as well as DVDs, Audio CDs,
  VCDs, and various streaming protocols.
  NOTE. This snap contains an untested daily build of VLC
confinement: strict
compression: lzo
platforms:
  amd64:
  arm64:

layout:
  /usr/share/X11:
    bind: $SNAP/usr/share/X11
  /usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/alsa-lib:
    bind: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/alsa-lib
  /usr/share/alsa:
    bind: $SNAP/usr/share/alsa
  /etc/asound.conf:
    bind-file: $SNAP/etc/asound.conf

plugs:
  dot-config-aacs:
    interface: personal-files
    read:
    - $HOME/.config/aacs

apps:
  vlc:
    desktop: usr/share/applications/vlc.desktop
    command-chain: [bin/desktop-launch]
    command: bin/vlc-snap-wrapper.sh
    common-id: org.videolan.vlc
    plugs:
      - alsa
      - network
      - network-bind
      - home
      - opengl
      - mount-observe
      - optical-drive
      - camera
      - removable-media
      - screen-inhibit-control
      - x11
      - wayland
      - desktop
      - desktop-legacy
      - dvb
      - audio-playback
      - audio-record
      - avahi-control
      - dot-config-aacs
    slots:
      - mpris

parts:
  alsa-mixin:
    plugin: dump
    source: https://github.com/diddlesnaps/snapcraft-alsa.git
    source-subdir: snapcraft-assets
    build-packages:
      - libasound2-dev
    stage-packages:
      - libasound2t64
      - libasound2-plugins
      - yad
    stage:
      - etc/asound.conf
      - snap/command-chain/alsa-launch
      - usr/bin/yad*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/alsa-lib
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libasound*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libdnsfile*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libFLAC*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libjack*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libpulse*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libsamplerate*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libspeex*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libvorbis*
      - usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/pulseaudio
  deps:
    plugin: nil
    stage-packages:
      - libqt6svg6
      - locales-all
      - libxkbcommon0
      - xkb-data
      - shared-mime-info
      - mesa-utils
      - libxcb-damage0
      - libvpx9
  wrapper:
    plugin: nil
    source: snap/local
    override-build: |
      mkdir -p $CRAFT_PRIME/bin
      cp -p $CRAFT_PROJECT_DIR/snap/local/desktop-launch $CRAFT_PRIME/bin/
      cp -p $CRAFT_PROJECT_DIR/snap/local/vlc-snap-wrapper.sh $CRAFT_PRIME/bin/
      chmod a+x $CRAFT_PRIME/bin/{desktop-launch,vlc-snap-wrapper.sh}
  vlc:
    source: https://code.videolan.org/videolan/vlc.git
    source-type: git
    source-branch: 3.0.x
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/usr
      - --enable-qt
      - --enable-wayland
      - --enable-pipewire
      - --enable-pulse
      - --enable-avcodec
      - --enable-avformat
      - --enable-swscale
      - --enable-ogg
      - --enable-mpg123
      - --enable-flac
      - --enable-vorbis
      - --enable-x264
      - --enable-x265
      - --enable-vpx
      - --enable-dav1d
      - --enable-xcb
      - --enable-vulkan
      - --enable-lua
      - --disable-oss
      - --disable-avahi
      - --disable-jack
      #- --disable-smbclient
      #- --disable-samba
      - --disable-replace-samba
    override-pull: |
      craftctl default
      craftctl set version=$(git describe --always HEAD)
    override-build: |
      craftctl default
      sed -i 's|/root/parts/vlc/install|$SNAP|g' $CRAFT_PART_INSTALL/usr/bin/{c,n,r}vlc
      sed -i 's|Icon=vlc|Icon=/usr/share/icons/hicolor/256x256/apps/vlc\.png|' $CRAFT_PART_INSTALL/usr/share/applications/vlc.desktop
      sed -i 's|TryExec=.*|TryExec=/snap/bin/vlc|' $CRAFT_PART_INSTALL/usr/share/applications/vlc.desktop
      find  $CRAFT_PART_INSTALL/ -type f -name '*.la' -delete
    build-packages:
      - qtbase5-dev
      - qtdeclarative5-dev
      - qtbase5-private-dev
      - libqt5svg5-dev
      - libqt5widgets5t64
      - libqt5waylandclient5-dev
      - libqt5x11extras5-dev
      - libsmbclient-dev
      - meson
      - libnotify-dev
      - libupnp-dev
      - libarchive-dev
      - libpipewire-0.3-dev
      - libmpg123-dev
      - libvorbis-dev
      - libvpx-dev
      - libdav1d-dev
      - libaudio-dev
      - libltdl-dev
      - libopenal-dev
      - portaudio19-dev
      - gettext
      - intltool
      - libtool
      - autopoint
      - libavformat-dev
      - libswscale-dev
      - libxcursor-dev
      - libharfbuzz-dev
      - libx265-dev
      - libx264-dev
      - libflac-dev
      - libogg-dev
      - wayland-protocols
      - git
      - make
      - build-essential
      - libxcb-xfixes0-dev
      - dpkg-dev
      - libasound2-dev
      - libavahi-client-dev
      - libcdio-dev
      - libdbus-1-dev
      - libdirectfb-dev
      #- libegl1-mesa-dev
      - libfreetype6-dev
      - libfribidi-dev
      #- libgles2-mesa-dev
      - libgnutls28-dev
      - libidn11-dev
      #- libjack-dev
      #- liblircclient-dev
      - liblua5.2-dev
      - libmtp-dev
      - libncursesw5-dev
      - libpng-dev
      - librsvg2-dev
      - libsecret-1-dev
      - libudev-dev
      - libv4l-dev
      - libva-dev
      - libvdpau-dev
      - libx11-dev
      - libxcb-composite0-dev
      - libxcb-damage0-dev
      - libxcb-keysyms1-dev
      - libxcb-randr0-dev
      - libxcb-shm0-dev
      - libxcb-xv0-dev
      - libxcb1-dev
      - libxext-dev
      - libxi-dev
      - libxinerama-dev
      - libxkbcommon-x11-dev
      #- libxml2-dev
      - libxpm-dev
      - libzvbi-dev
      - lua5.2
      - pkg-config
      - xz-utils
      - zlib1g-dev
      - bison
      - flex
      - libvulkan-dev
      - libgcrypt20-dev
      - libsystemd-dev
    stage-packages:
      - libdrm2
      - libsmbclient
      - libproxy1v5
      - libxinerama1
      - libxpm4
      - libnotify4
      - libixml11t64
      - libupnp17t64
      - libarchive13t64
      - libidn12
      - libx264-164
      - libx265-199
      - libharfbuzz0b
      - libva-wayland2
      - libxcb-xv0
      - libatomic1
      - libavahi-common3
      - libavcodec-extra60
      - libavcodec60
      - libavformat-extra60
      - libavformat60
      - libavutil58
      - libfribidi0
      - libgl1
      #- libjack-jackd2-0
      #- libjack0
      - liblua5.2-0
      - libmtp9t64
      - librsvg2-2
      - libsecret-1-0
      - libswscale7
      - libxcb-composite0
      - libzvbi0t64
      #- pipewire-jack
      - primus-libs
      - libflac12t64
      - libflac++10
      - liboggplay1
      - libxcursor1
      - libpulse0
      - libpipewire-0.3-0t64
      - libqt5widgets5t64
      - libqt5gui5t64
      - libqt5svg5
      - libqt5core5a
      - libqt5core5t64
      - libqt5gui5-gles
      - libqt5x11extras5
    prime:
      - -usr/lib/*/cmake
      - -usr/include
      - -usr/share/ECM
      - -usr/share/doc
      - -usr/share/man
      - -usr/bin/X11
      - -usr/lib/gcc
      - -usr/lib/aspell
      - -usr/lib/carla*
      - -usr/lib/python3/dist-packages/PyQt5
